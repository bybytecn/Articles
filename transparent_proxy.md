---
layout: post
title: Windows上做透明代理
date: 2022-03-24 21:13:00
tags: [代理]
---
# 引言
能看到这里的人，相信平时都会经常上GitHub、Google的，而因为万恶的Q导致每次都要开一次，非常麻烦，还有一些不是走HTTP代理的应用，就更麻烦了，所以省去每次都要手动开✈十分必要了。

# 透明代理
透明代理通俗的解释就是你接上路由器后，或者用上某个网关后，无需设置你就能🚀了。网关会自动帮你代理完成那一步工作。

# 旁路由
主路由大家都很熟悉，平常你家用的路由器就是主路由器，负责转发数据出到互联网，有主就有旁，旁路由做一些特俗的工作，比如广告过滤、屏蔽一些特殊网站等，最常用的是🚀上网了，我们的手机电脑设备经过旁路由，旁路由处理完后，再转发给主路由，主路由再转出去。

# 部署虚拟机作代理网关
由于笔者这里没有多余的电脑和路由器设备，所以在本机上用虚拟机虚拟一台和主机在同一内网下的主机，用来当旁路由

#### 安装步骤
装虚拟机相信都会了，去下个Linux系统（笔者装的是Ubuntu），按步骤慢慢做就行了，但要注意虚拟机的网络模式要选择***桥接模式***。

#### 开启数据转发使其成为网关
系统装完了，我们需要这台虚拟机作为网关，就是能转发数据，默认装的都是没开启转发的，需要手动设置一下，用下面这条命令，不了解的可以百度一下
```
sysctl net.ipv4.ip_forward=1
```

# 需要的工具
* redsocks
* 🚀工具
* iptables

## 🚀工具
你自己平常用的那个,酸酸乳啊之类的都行，一般都会监听一个本地的代理端口，有HTTP和SOCKS的，记下那个Socks 端口，下面的redsocks要用。

## redsocks
这个是核心了，可以把你TCP数据包装成Socks Client数据包转发Socks Server完成代理，细节这里不展开了，网上有详细的用法

## iptables
Linux系统的一个防火墙工具，需要用到的是下面的命令
```
iptables -t nat -I PREROUTING -p tcp -j REDIRECT --to 123456
```
> 这行命令的意思是把本机需要转发的数据转发到本机的123456端口

# 改变本机的网关
如果虚拟机的设置你都设置好了，其能作为旁路由🚀上网了，但是你主机还要设置一下这台虚拟机做你的主路由，Windows下用如下命令

先删除默认的主路由
```
route del 0.0.0.0 mask 0.0.0.0
```
再设置成旁路由
```
route add 0.0.0.0 mask 0.0.0.0 192.X.X.X
```
后面的192.X.X.X是你的那台虚拟机的IP地址

# 原理过程
上面只是简述了一下，下面简述一下整个代理过程的原理，方便读者理解实践：
从你本机发出的数据，通过查看路由表，发现主路由是你的虚拟机网关，转发过去，虚拟机网关收到了，转发到本机的12345（在我这里是redsocks监听的端口），redsocks包装成Socks5协议，转发到你的🚀工具，你的🚀工具再转发到外面去。